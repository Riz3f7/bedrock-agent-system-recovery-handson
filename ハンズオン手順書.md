# AWS Bedrock エージェントハンズオン手順書

このハンズオンでは、AWS Bedrock エージェント（Amazon Nova Pro）を使用して、EC2インスタンス上で動作するFlaskアプリケーションのトラブルシューティングを自動化するシステムを構築します。

## 📋 アジェンダ

### 事前準備
- Amazon Nova Pro の有効化
- Bedrock モデルアクセスの設定

### ステップ1: EC2インスタンスの準備
- CloudFormation テンプレートの使用
- EC2インスタンス + Flask アプリケーションの自動構築
- Session Manager での接続確認
- アプリケーション動作確認とエラーテスト

### ステップ2: IAMロールの作成
- Lambda関数用カスタムポリシーの作成
- BedrockAgentLambdaRole の作成

### ステップ3: Lambda関数の作成
- ログ取得Lambda関数の作成と設定
- インスタンス再起動Lambda関数の作成と設定
- 権限設定とテスト実行

### ステップ4: Bedrock エージェントの作成
- エージェントの基本設定
- アクショングループの作成
- APIスキーマの定義
- エージェントの準備

### ステップ5: エージェントのテスト
- 基本動作テスト
- システム状況確認
- 実際の再起動テスト
- エラーシナリオテスト

### ステップ6: 動作確認
- CloudWatch Logs確認
- Lambda関数実行ログ確認

### リソースのクリーンアップ
- 作成したリソースの削除手順

---

## 🎯 ハンズオンの目標

- AWS Bedrockエージェントの基本的な使い方を学ぶ
- Lambda関数とエージェントの連携方法を理解する
- CloudWatch Logsとの統合を体験する
- 実際のトラブルシューティング自動化を実装する
- セッションマネージャーを使用した安全なEC2接続を体験する

## ⏱️ 所要時間

約 1 時間（CloudFormation自動化により大幅短縮）

## 📋 前提条件

- AWSアカウントを持っていること
- AWS Management Consoleにアクセスできること
- 基本的なAWSサービス（EC2、Lambda、CloudWatch）の知識があること
- Amazon Nova Proが利用可能なリージョンを使用すること（推奨: us-east-1, us-west-2）

## 🏗️ アーキテクチャ概要

[ユーザー] → [Bedrock エージェント] → [Lambda関数] → [CloudWatch Logs / EC2]
                                    ↓
                              [ログ分析・インスタンス再起動]
                                    ↑
                            [Session Manager経由でアクセス]

---

## 📝 ハンズオン手順

### 事前準備: Amazon Nova Proの有効化 
#### 事前-1. Bedrockサービスへのアクセス

1. **AWS Management Console** にログイン
2. **リージョンの確認**: Amazon Nova Pro対応リージョン（us-east-1, us-west-2等）を選択
3. **Amazon Bedrock** サービスに移動

#### 事前-2. モデルアクセスの有効化

1. 左側メニューから **「モデルアクセス」** を選択
2. **「モデルアクセスを変更」** ボタンをクリック
3. **Amazon Nova Pro** を探してチェックボックスを選択
4. 利用規約がある場合は確認して同意
5. **「次へ」** → **「送信」** をクリック
6. ステータスが **「アクセスが付与されました」** になることを確認

**重要**: モデルアクセスの有効化には数分かかる場合があります。

---

### ステップ1: CloudFormationを使用したEC2インスタンスの準備 
#### 1-1. CloudFormationテンプレートの確認

**事前準備として、プロジェクトに含まれる `ec2-flask-template.yaml` を確認します。**

このテンプレートには以下が含まれています：
- Amazon Linux 2023を使用したEC2インスタンス
- Session Manager接続用のIAMロール
- HTTP接続用のセキュリティグループ
- CloudWatch Agent設定
- Flask アプリケーションの自動デプロイ

#### 1-2. CloudFormationスタックの作成

1. **AWS Management Console** にログイン
2. **CloudFormation** サービスに移動
3. **「スタックの作成」** → **「新しいリソースを使用 (標準)」** をクリック

#### 1-3. テンプレートのアップロード

1. **「テンプレートファイルのアップロード」** を選択
2. **「ファイルを選択」** をクリック
3. ローカルの `ec2-flask-template.yaml` ファイルを選択
4. **「次へ」** をクリック

#### 1-4. スタックの詳細設定

**スタックの詳細:**
スタック名: bedrock-agent-demo-stack

**パラメータ設定:**
InstanceType: t3.micro (デフォルト)
VpcId: [利用可能なVPCを選択]
SubnetId: [パブリックサブネットを選択]

**重要**: パブリックIPが自動割り当てされるサブネットを選択してください。

5. **「次へ」** をクリック

#### 1-5. スタックオプションの設定

1. **スタックオプション** はデフォルトのまま
2. **「次へ」** をクリック

#### 1-6. 確認と作成

1. 設定内容を確認
2. **「AWS CloudFormation によって IAM リソースが作成される場合があることを承認します」** にチェック
3. **「スタックの作成」** をクリック

#### 1-7. スタック作成の完了確認

1. **「イベント」** タブでスタック作成の進行状況を確認
2. ステータスが **「CREATE_COMPLETE」** になるまで待機（約5-10分）
3. **「出力」** タブで以下の情報を確認:
   - **InstanceId**: 作成されたEC2インスタンスのID
   - **PublicIP**: パブリックIPアドレス
   - **WebsiteURL**: FlaskアプリケーションのURL
   - **SessionManagerURL**: Session Managerアクセス用URL

#### 1-8. Session Managerでの接続確認

1. CloudFormation出力の **SessionManagerURL** をクリック、または
2. **EC2コンソール** → 作成されたインスタンスを選択 → **「接続」** → **「セッションマネージャー」** → **「接続」**

#### 1-9. アプリケーションの動作確認

**CloudFormationテンプレートにより、FlaskアプリケーションとCloudWatch Agentは自動的にインストール・設定されています。**

```bash
# アプリケーションの状態確認
sudo systemctl status flask-app
```

```bash
# エラー発生テスト（Lambda関数テストに重要）
curl http://localhost/error

# ログファイルの確認（重要：ここでERRORが出力されているか確認）
sudo tail -f /var/log/my-flask-app.log
```

**重要**: エラー発生テストを実行後、CloudWatch Logsでエラーログが記録されることを確認してください。これがLambda関数テストの前提条件です。

#### 1-10. CloudWatch Logsの確認

1. **CloudWatch** サービスに移動
2. **「ログ」** → **「ロググループ」**
3. `/aws/ec2/my-flask-application` でログが記録されていることを確認

---

### ステップ2: IAMロールの作成 
#### 2-1. EC2用IAMロールの確認

**CloudFormationテンプレートにより、EC2インスタンス用のIAMロールは自動的に作成されています。**

1. **IAMサービス** に移動
2. **「ロール」** で **「bedrock-agent-demo-stack-FlaskAppRole-xxxxxxxxx」** を確認
3. 以下のポリシーがアタッチされていることを確認:
   - `AmazonSSMManagedInstanceCore`
   - `CloudWatchAgentServerPolicy`

#### 2-2. カスタムポリシーの作成

**まず、Lambda関数用のカスタムポリシーを作成します。**

1. **IAMサービス** に移動
2. **「ポリシー」** → **「ポリシーを作成」** をクリック
3. **JSON** タブを選択
4. 以下のポリシーをコピー&ペースト:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:DescribeLogGroups",
        "logs:DescribeLogStreams",
        "logs:GetLogEvents",
        "logs:FilterLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:log-group:/aws/ec2/my-flask-application:*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "ec2:RebootInstances"
      ],
      "Resource": "*"
    }
  ]
}
```

5. **ポリシー名**: `BedrockAgentLambdaPolicy`
6. **「ポリシーを作成」**

#### 2-3. Lambda実行ロールの作成

1. **IAMサービス** に移動
2. **「ロール」** → **「ロールを作成」**
3. **信頼されたエンティティタイプ**: AWSサービス
4. **ユースケース**: Lambda
5. **「次へ」** をクリック

#### 2-4. ポリシーのアタッチ

**以下のポリシーを検索してアタッチ:**

1. **`AWSLambdaBasicExecutionRole`** を検索
2. **チェックボックスにチェックを入れる**
3. **`BedrockAgentLambdaPolicy`** を検索（先ほど作成したポリシー）
4. **チェックボックスにチェックを入れる**
5. **「次へ」** をクリック

#### 2-5. ロールの完成

1. **ロール名**: `BedrockAgentLambdaRole`
2. **「ロールを作成」**

---

### ステップ3: Lambda関数の作成 
#### 3-1. ログ取得Lambda関数の作成

1. **Lambdaサービス** に移動
2. **「関数の作成」** をクリック
3. **「一から作成」** を選択

**基本情報:**
- 関数名: get-log
- ランタイム: Python 3.13
- アーキテクチャ: x86_64
- デフォルトの実行ロールの変更: 既存のロールを使用する → BedrockAgentLambdaRole

4. **「関数の作成」** をクリック

#### 3-2. ログ取得Lambda関数のコード

**重要**: デフォルトのコードを完全に削除して、以下のコードに **置き換え** してください。

1. **「コード」** タブをクリック
2. **lambda_function.py** の内容をすべて削除
3. 以下のコードを **コピー&ペースト**:

プロジェクトフォルダにある `get-log.py` ファイルの内容をすべてコピーして、Lambda関数のコードエディタにペーストしてください。

4. **「Deploy」** ボタンをクリックして **必ずデプロイ** してください

**重要**: Deployしないとコードの変更が反映されません！Deploy完了まで待機してください。

#### 3-3. ログ取得Lambda関数の設定

**Deploy完了後、設定を変更してからテストを実行します：**

1. **「設定」** タブをクリック
2. **「一般設定」** → **「編集」**

**設定値:**
- タイムアウト: 5分
- メモリ: 512 MB

3. **「保存」** をクリック

#### 3-4. ログ取得Lambda関数の権限設定

**設定変更完了後、権限設定を行います：**

1. **「設定」** タブをクリック（既に設定画面にいる場合はそのまま）
2. **「アクセス権限」** をクリック
3. **リソースベースのポリシーステートメント** セクションで **「アクセス権限を追加」** をクリック
4. 以下の設定を入力：

- ステートメントID: bedrock-agent-access
- プリンシパル: bedrock.amazonaws.com
- アクション: lambda:InvokeFunction

**AWSアカウントIDの確認方法:**
- AWS Management Consoleの右上のアカウント名をクリック
- 表示される12桁の数字がアカウントID

**重要**: 
- `[アカウントID]` を実際のAWSアカウントIDに置き換えてください
- 初回作成時にはソースARN入力欄がない場合があります
- 作成後、ステートメントを編集して以下を追加:
  ソースARN: arn:aws:bedrock:us-east-1:[アカウントID]:agent/*

5. **「保存」** をクリック

#### 3-5. ログ取得Lambda関数のテスト

**権限設定完了後、テストを実行してください：**

1. **「テスト」** タブをクリック
2. **「新しいイベントを作成」**
3. **イベント名**: `test-get-logs`
4. **イベントJSON**:

```json
{
  "parameters": [
    {"name": "logGroup", "value": "/aws/ec2/my-flask-application"},
    {"name": "hoursAgo", "value": "24"}
  ],
  "actionGroup": "RetrieveLogsActionGroup",
  "apiPath": "/get-logs",
  "httpMethod": "GET"
}
```

5. **「テスト」** をクリック

**期待される結果:**
- ステータスコードが200であること
- レスポンス形式が正しいこと
- エラーがないこと
- **"Hello from Lambda!"** が返される場合は、Deployが完了していません

**レスポンス確認ポイント:**
```json
{
  "messageVersion": "1.0",
  "response": {
    "actionGroup": "RetrieveLogsActionGroup",
    "apiPath": "/get-logs",
    "httpMethod": "GET",
    "httpStatusCode": 200,
    "responseBody": {
      "application/json": {
        "body": {
          "status": "success",
          "error_logs": [...],
          "summary": {...}
        }
      }
    }
  }
}
```

#### 3-6. インスタンス再起動Lambda関数の作成

1. **「関数の作成」** をクリック
2. **「一から作成」** を選択

**基本情報:**
関数名: reboot-instances
ランタイム: Python 3.13
アーキテクチャ: x86_64
デフォルトの実行ロールの変更: 既存のロールを使用する → BedrockAgentLambdaRole

3. **「関数の作成」** をクリック

#### 3-7. インスタンス再起動Lambda関数のコード

**重要**: デフォルトのコードを完全に削除して、以下のコードに **置き換え** してください。

1. **「コード」** タブをクリック
2. **lambda_function.py** の内容をすべて削除
3. プロジェクトフォルダにある `reboot-instances.py` ファイルの内容をすべてコピーして、Lambda関数のコードエディタにペーストしてください
4. **「Deploy」** ボタンをクリックして **必ずデプロイ** してください

**重要**: Deployしないとコードの変更が反映されません！Deploy完了まで待機してください。

#### 3-8. インスタンス再起動Lambda関数の設定

**Deploy完了後、設定を変更してからテストを実行します：**

1. **「設定」** タブをクリック
2. **「一般設定」** → **「編集」**

**設定値:**
タイムアウト: 5分
メモリ: 256 MB

3. **「保存」** をクリック

#### 3-9. インスタンス再起動Lambda関数の権限設定

**設定変更完了後、権限設定を行います：**

1. **「設定」** タブをクリック（既に設定画面にいる場合はそのまま）
2. **「アクセス権限」** をクリック
3. **リソースベースのポリシーステートメント** セクションで **「アクセス権限を追加」** をクリック
4. 以下の設定を入力：

- ステートメントID: bedrock-agent-access
- プリンシパル: bedrock.amazonaws.com
- アクション: lambda:InvokeFunction

**重要**: 
- 上記「3-5. ログ取得Lambda関数の権限設定」で確認したアカウントIDを使用
- 初回作成時にはソースARN入力欄がない場合があります
- 作成後、ステートメントを編集して以下を追加:
  ソースARN: arn:aws:bedrock:us-east-1:[アカウントID]:agent/*

5. **「保存」** をクリック

#### 3-10. インスタンス再起動Lambda関数のテスト

**権限設定完了後、テストを実行してください：**

1. **「テスト」** タブをクリック
2. **「新しいイベントを作成」**
3. **イベント名**: `test-reboot-dryrun`

4. **インスタンスIDの確認:**

  1. **CloudFormation** サービスに移動
  2. **「bedrock-agent-demo-stack」** スタックを選択
  3. **「出力」** タブをクリック
  4. **「InstanceId」** の値をコピー (例: i-xxxxxxxxxxxxxxx)

5. **イベントJSON** (上記で確認したインスタンスIDに変更):

{
  "parameters": [
    {"name": "instanceId", "value": "i-xxxxxxxxxxxxxxx"},
    {"name": "dryRun", "value": "true"}
  ],
  "actionGroup": "test",
  "apiPath": "/reboot",
  "httpMethod": "POST"
}

6. **「テスト」** をクリック

**期待される結果:**
- ドライランが正常に実行されること
- インスタンス情報が正しく取得されること
- エラーがないこと

---

### ステップ4: Bedrock エージェントの作成 
#### 4-1. Bedrockエージェントの作成

**事前準備でAmazon Nova Proを有効化済みの前提で進めます。**

1. **Amazon Bedrock** サービスに移動
2. 左側メニューから **「エージェント」** を選択
3. **「エージェントを作成」** をクリック

#### 4-2. エージェントの基本設定

**エージェントの詳細:**
エージェント名: bedrock-troubleshooting-agent
説明: EC2インスタンスのトラブルシューティングを自動化するエージェント

**モデル選択:**
モデル: Amazon Nova Pro

**Nova Proの利点:**
- Amazonの最新ファウンデーションモデル（2024年12月リリース）
- 高いコスト効率性
- 優れた推論能力とコード理解
- 日本語サポート
- 技術的なトラブルシューティングタスクに最適化

**注意事項:**
- Nova Proが利用可能なリージョンであることを確認
- モデルのアクセス許可が有効になっていることを確認

#### 4-3. エージェント指示の設定

**指示** 欄に以下の内容を **コピー&ペースト**:

プロジェクトフォルダにある `エージェント/エージェントへの指示.txt` ファイルの内容をすべてコピーして、エージェントの指示欄にペーストしてください。

**重要**: エージェント向けの指示を入力後、一度 **「保存」** を押してからアクショングループを作成してください。指示内容が消える場合があります。

#### 4-4. アクショングループの作成

**ログ取得アクショングループ:**
1. **アクショングループ** セクションの **「追加」** ボタンをクリック
2. **アクショングループの詳細:**

アクショングループ名: RetrieveLogsActionGroup
説明: CloudWatch Logsからエラーログを取得
アクショングループタイプ: API スキーマで定義

3. **アクショングループの呼び出し:**
   - **既存の Lambda 関数を選択** → `get-log`

4. **APIスキーマの定義:**
   **インラインスキーマエディタで定義** を選択し、プロジェクトフォルダにある `log-retrieval-api-schema.json` ファイルの内容をコピー&ペーストしてください。

5. **「作成」** をクリック

**インスタンス再起動アクショングループ:**
1. **アクショングループ** セクションの **「追加」** ボタンをクリック
2. **アクショングループの詳細:**

アクショングループ名: RebootInstancesActionGroup
説明: EC2インスタンスの安全な再起動
アクショングループタイプ: API スキーマで定義

3. **アクショングループの呼び出し:**
   - **既存の Lambda 関数を選択** → `reboot-instances`

4. **APIスキーマの定義:**
   **インラインスキーマエディタで定義** を選択し、プロジェクトフォルダにある `instance-reboot-api-schema.json` ファイルの内容をコピー&ペーストしてください。

5. **「作成」** をクリック

#### 4-5. エージェントの準備

1. アクショングループ作成後、**「保存」** をクリック
2. **「準備」** をクリック
3. 準備プロセスが完了するまで待機（数分かかります）

---

### ステップ5: エージェントのテスト 
#### 5-1. エージェントテストの実行

**エージェント準備完了後、画面右側にテストエージェントが表示されます。**

**テスト画面の見やすさ改善:**
- **画面を広くする**: ブラウザを全画面表示にする
- **ズームアウト**: ブラウザのズームを75-80%に設定
- **チャット履歴の確認**: 左側のチャット履歴で過去の応答を確認可能
- **コピー機能**: 応答をクリックしてコピー → メモ帳等に貼り付けて確認

#### 5-2. 基本動作テスト

**テスト1: システム状況確認**
ユーザー入力: "システムの状況を確認してください"

**期待される動作:**
- エージェントがRetrieveLogsアクションを実行
- ログ分析結果を表示
- エラーの有無を報告

**✅ 正常動作の確認ポイント:**
- インスタンスIDが正確に抽出されている
- テストエラーであることを適切に認識
- 再起動が不要であることを正しく判断

**応答例の確認ポイント:**
- インスタンスID（i-xxxxxxxxx）が正しく抽出されているか
- エラーの重要度が適切に分析されているか
- 再起動の必要性が適切に判断されているか

**表示改善のコツ:**
1. **応答の全文をコピー**: 応答エリアをクリック → Ctrl+A → Ctrl+C
2. **メモ帳に貼り付け**: 改行が正しく表示される
3. **ブラウザの開発者ツール**: F12キー → Console タブで詳細確認


**テスト2: 実際の再起動テスト**
ユーザー入力: "エラーログが出力されているインスタンスを再起動してください"
ユーザー確認: "はい"

**再起動確認方法:**

1. **EC2コンソールでの確認**:
   - EC2サービス → インスタンス
   - 対象インスタンスの **「状態」** カラムを確認
   - `running` → `stopping` → `pending` → `running` の遷移を確認

3. **Session Managerでの確認**:
   - Session Managerで接続して、システムの起動時刻を確認
   - 再起動ログやシステム起動ログを確認

4. **CloudWatch メトリクスでの確認**:
   - CloudWatch → メトリクス → EC2 → Per-Instance Metrics
   - インスタンスIDで検索 → **StatusCheckFailed** メトリクス
   - 再起動時にメトリクスが一時的に途切れることを確認

5. **Flask アプリケーションでの確認**:
   - ブラウザでアプリケーションにアクセスして動作確認
   - プロセスの起動時刻を確認

**再起動完了の確認ポイント:**
- ✅ EC2コンソールで状態が `running` に戻る
- ✅ Session Manager で接続できる  
- ✅ Flask アプリケーションが応答する
- ✅ Session Managerで短い稼働時間が確認される

**最も簡単な確認方法:**
1. **EC2コンソール**を開いたまま再起動を実行
2. **「更新」**ボタンを数回クリックして状態変化を確認
3. **Session Manager**で稼働時間を確認（短い稼働時間が表示される）

**注意**: 再起動には通常2-3分かかります。Session Managerの接続も一時的に切断されます。
---

## 🎉 ハンズオン完了

### 🎯 達成したこと

✅ **AWS Bedrockエージェントの構築**
- Amazon Bedrock を活用した高度なAIエージェント
- 自然言語でのシステム操作

✅ **Lambda関数との連携**
- ログ分析の自動化
- インスタンス管理の自動化

✅ **実用的なトラブルシューティング自動化**
- エラー検出から解決までの自動化
- 安全性を考慮した操作確認

---

---

## 🧹 掃除手順（リソースのクリーンアップ）

ハンズオン完了後は、不要な課金を避けるために以下の手順でリソースを削除してください。

### 1. Bedrock エージェントの削除 
1. **Amazon Bedrock** サービスに移動
2. 左側メニューから **「エージェント」** を選択
3. 作成したエージェント **「bedrock-troubleshooting-agent」** を選択
4. **「削除」** をクリック
5. 削除の確認ダイアログで **「削除」** をクリック

### 2. Lambda関数の削除 1. **AWS Lambda** サービスに移動
2. **「get-log」** 関数を選択
3. **「アクション」** → **「削除」**
4. 削除の確認で関数名を入力
5. **「削除」** をクリック

同様に以下の関数も削除：
- **「reboot-instances」**

### 3. IAMロールとポリシーの削除 
**カスタムポリシーの削除:**
1. **IAM** サービスに移動
2. **「ポリシー」** → **「BedrockAgentLambdaPolicy」** を検索
3. ポリシーを選択 → **「削除」**
4. 削除の確認で **「削除」** をクリック

**Lambda実行ロールの削除:**
1. **「ロール」** → **「BedrockAgentLambdaRole」** を検索
2. ロールを選択 → **「削除」**
3. 削除の確認で **「削除」** をクリック

### 4. CloudFormationスタックの削除 
**重要**: CloudFormationスタックを削除すると、EC2インスタンス、IAMロール、セキュリティグループなどが一括削除されます。

1. **AWS CloudFormation** サービスに移動
2. **「bedrock-agent-demo-stack」** を選択
3. **「削除」** をクリック
4. 削除の確認ダイアログで **「削除」** をクリック
5. 削除の完了まで約5-10分待機

**削除の確認:**
- スタックの状態が **「DELETE_COMPLETE」** になることを確認
- **「削除されたスタック」** の表示で確認可能

### 5. CloudWatch Logsの削除 
**ロググループの削除:**
1. **Amazon CloudWatch** サービスに移動
2. **「ログ」** → **「ロググループ」**
3. 以下のロググループを削除：
   - `/aws/ec2/my-flask-application`
   - `/aws/lambda/get-log`
   - `/aws/lambda/reboot-instances`

各ロググループについて：
1. チェックボックスを選択
2. **「アクション」** → **「削除」**
3. 削除の確認で **「削除」** をクリック

### 6. その他のリソース確認 
**VPCとサブネットの確認:**
- デフォルトVPCを使用した場合は削除不要
- カスタムVPCを作成した場合のみ削除を検討

**セキュリティグループの確認:**
1. **EC2** サービス → **「セキュリティグループ」**
2. ハンズオンで作成したセキュリティグループを確認
3. CloudFormationスタック削除で自動削除されているはず

### 7. 削除完了の確認

**課金対象リソースが削除されていることを確認:**

1. **EC2インスタンス**: 実行中のインスタンスがないこと
2. **Lambda関数**: ハンズオン用の関数が削除されていること
3. **CloudWatch Logs**: ログデータの保存が停止していること
4. **Bedrock エージェント**: エージェントが削除されていること

**課金の確認:**
1. **請求とコスト管理** コンソールで使用量を確認
2. 翌日以降の請求に今回のハンズオン分が反映

### 8. 注意事項

**削除しないでください:**
- デフォルトVPC
- デフォルトセキュリティグループ
- AWSサービスのデフォルトロール

**削除順序:**
1. Bedrock エージェント (依存関係あり)
2. Lambda関数 (依存関係あり)  
3. IAMロールとポリシー
4. CloudFormationスタック (一括削除)
5. CloudWatch Logs

**トラブルシューティング:**
- CloudFormationスタックが削除できない場合は、依存リソースを手動で削除
- エラーが発生した場合は、AWSサポートに相談

---
### ステップ6: 動作確認とトラブルシューティング #### 6-3. よくある問題と解決方法

**問題1: CloudWatch Logsにログが表示されない**
- Session ManagerでEC2インスタンスに接続してCloudWatch Agentの状態を確認
- CloudWatch Agent設定ファイルの内容を確認
- EC2コンソールでインスタンスのIAMロール（FlaskAppRole）が正しく設定されているか確認

**問題2: Session Managerで接続できない**
- CloudFormationスタックが正常に作成されているか確認
- EC2インスタンスにIAMロール（FlaskAppRole）が正しくアタッチされているか確認
- Systems Manager エージェントが実行されているかSession Managerで確認

**問題3: Flaskアプリケーションが起動していない**
- Session Managerでアプリケーションの状態を確認
- アプリケーションログを確認
- 必要に応じて手動で起動テストを実行

**問題4: Lambda関数がタイムアウトする**
- タイムアウト時間を延長
- メモリサイズを増加

**問題5: エージェントがLambda関数にアクセスできない**
エラー: "Access denied while invoking Lambda function"
**解決方法:**
1. Lambda関数の **「設定」** → **「アクセス権限」** → **「リソースベースのポリシーステートメント」**
2. Bedrockからの呼び出しを許可するポリシーが設定されているか確認
3. ソースARNが正しいアカウントIDになっているか確認

**問題6: Lambda関数のレスポンスエラー**
エラー: "The server encountered an error processing the Lambda response"
**解決方法:**
1. **Lambda関数のログを確認:**
   - CloudWatch Logsでエラー詳細を確認
2. **よくある原因:**
   - レスポンス形式が不正（JSON構造エラー）
   - 必須フィールドの欠如
   - 文字エンコーディングの問題
   - タイムアウトエラー

3. **Lambda関数のテスト実行で詳細確認:**
   - Lambda Console → テスト → 実行結果とログを確認

**緊急対応手順:**
1. **Lambda関数を直接テスト:**
   {
     "parameters": [
       {"name": "logGroup", "value": "/aws/ec2/my-flask-application"},
       {"name": "hoursAgo", "value": "24"}
     ],
     "actionGroup": "RetrieveLogsActionGroup",
     "apiPath": "/get-logs",
     "httpMethod": "GET"
   }

2. **CloudWatch Logsでエラー確認:**
   - AWS Console → CloudWatch → ログ
   - `/aws/lambda/get-log` を確認
   - 最新のエラーログを確認

3. **よくある修正点:**
   - **Deploy忘れ**: コード変更後にDeployボタンを押していない
   - レスポンスのJSON形式確認
   - `ensure_ascii=False` の設定確認
   - 例外処理の見直し

**問題0: Lambda関数が古いコードを実行している**
```
症状: "Hello from Lambda!" が返される
```
**解決方法:**
1. Lambda関数のコードを正しく置き換えたか確認
2. **「Deploy」** ボタンをクリックしたか確認
3. Deploy完了後に再テスト実行

**問題1: エラーログが見つからない（CloudWatchには存在）**

**症状:** "No error logs found" だが、CloudWatchにはErrorログが存在

**原因と解決方法:**

1. **ロググループ名の不一致:**
   - CloudWatchで実際のロググループ名を確認
   - `/aws/ec2/my-flask-application` が存在するか確認
   - 実際の名前が異なる場合は Lambda関数のパラメータを修正

2. **時間範囲の問題:**
   - テスト時に時間範囲を短くして確認（例：1時間に設定）

3. **時間の問題（最も可能性が高い）:**
   - ログの記録時刻とLambda実行時刻の差
   - タイムゾーンの違い（UTC vs JST）
   
**時間範囲の確認:**
テスト時に時間範囲を1時間に短縮して確認してください。

4. **フィルターパターンの確認:**
   -フィルタに `?ERROR ?Exception ?Traceback` を入力してCloudWatchで手動検索して確認

4. **IAM権限の問題:**
   **エラー:** "User is not authorized to perform: logs:FilterLogEvents"
   
   **緊急修正手順:**
   1. **IAMサービス** に移動
   2. **「ポリシー」** → **「BedrockAgentLambdaPolicy」** を検索・選択
   3. **「編集」** をクリック
   4. **「JSON」** タブでlogs:FilterLogEventsアクションを追加
   5. **「変更を保存」** をクリック
   6. 数分待機後、Lambda関数を再テスト

**問題2: インスタンス再起動でアクセス拒否**
**エラー:** "Instance i-xxxxxxxxx not found"
**原因と解決方法:**

1. **IAMポリシーの条件が厳しすぎる**:
   - 現在のポリシーに `ec2:ResourceTag/Environment` 条件がある
   - CloudFormationで作成したインスタンスにはこのタグがない

2. **緊急修正手順**:
   1. IAMサービス → ポリシー → BedrockAgentLambdaPolicy
   2. 編集 → JSON タブ
   3. EC2権限の部分でCondition部分を削除
   4. 変更を保存

3. **代替案（タグを追加する方法）**:
   
   **方法: EC2コンソールでタグ追加**
   1. EC2サービス → インスタンス
   2. 対象インスタンスを選択
   3. 「タグ」タブ → 「タグを管理」
   4. 「タグを追加」をクリック
   5. キー: Environment, 値: demo
   6. 「変更を保存」

**推奨**: IAMポリシーの条件を削除する方法が最も簡単です。

**問題3: インスタンス再起動Lambda関数のデバッグ**

**症状:** IAMポリシーは正しいが、まだ "Instance not found" エラー

**デバッグ手順:**

1. **Lambda関数 `reboot-instances` の直接テスト**:
   Lambda Consoleでテストイベントを作成して実行

2. **Lambda関数のログ確認**:
   - CloudWatch → ログ → `/aws/lambda/reboot-instances`
   - 実際のエラーメッセージを確認

3. **インスタンスIDの確認**:
   AWS Consoleでインスタンスが存在するか確認

4. **最も可能性が高い問題: Lambda関数のコード未設定**:
   - `reboot-instances` の **「コード」** タブを確認
   - **デフォルトコード（"Hello from Lambda!"）のままでないか確認**
   - `reboot-instances.py` のコードが正しく設定されているか
   - **Deploy** ボタンをクリックしたか確認

**緊急対応: Lambda関数がデフォルトコードの場合**
1. **Lambda関数のコードを完全に置き換え**
2. `reboot-instances.py` の全コードをコピー&ペースト
3. **「Deploy」** ボタンをクリック（重要！）
4. 数分待機後に再テスト

5. **Lambda関数のデバッグ出力追加**:
   Lambda関数にデバッグ用のprintを追加

**問題4: Lambda関数が出力なしで終了**

**症状:** ログに "Received event" のみ表示され、その後出力がない

**原因:** Python例外またはBedrockエージェント用レスポンス形式の問題

**緊急対応:**
1. **Lambda関数に詳細なデバッグを追加**
2. **Deployして再テスト**
3. **エラーログを詳細確認**

**一時的な簡易テスト用Lambda関数を使用してください。**

**問題解決: 簡易版が動作する場合は完全版Lambda関数に置き換えてください。**

**Deploy後のテスト手順:**
1. **「Deploy」** をクリック
2. ドライランテストを実行
3. 実際の再起動テストを実行

**次のステップ: Bedrockエージェントでの実際のテスト**
1. **「エージェントを準備」** (未実行の場合)
2. **「テスト」** タブでエージェントをテスト
3. 実際の再起動テストを実行

**デバッグ手順:**
1. **CloudWatchで手動確認**
2. **Lambda関数のログ確認**
3. **テスト用の簡単なフィルターを使用**

**緊急デバッグ手順:**
1. Lambda関数の `get-log` を開く
2. デバッグ出力を追加済みのコードをDeployする
3. テスト実行後、CloudWatch Logsで `/aws/lambda/get-log` を確認
4. 以下の情報を確認:
   - 検索時間範囲
   - 検出されたイベント数
   - 実際のエラーメッセージ

**最も可能性が高い原因: 時間範囲**
- エラーログが24時間以内に記録されているか確認
- テスト時に `"hoursAgo": "1"` を使用

**問題7: エージェントがアクションを実行できない**
- IAMロールの権限を確認
- APIスキーマの形式を確認
- Lambda関数のテスト実行

---
